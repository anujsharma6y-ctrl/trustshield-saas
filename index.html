document.getElementById('scan-btn').onclick = async function() {
    const urlInput = document.getElementById('repo-url').value;
    if(!urlInput.includes("github.com/")) { 
        alert("Please enter a valid GitHub URL"); 
        return; 
    }

    // URL se Owner aur Repo name nikalna
    const pathParts = urlInput.replace("https://github.com/", "").split("/");
    const owner = pathParts[0];
    const repo = pathParts[1];

    this.innerHTML = "üîç Fetching Repository Data...";
    this.disabled = true;

    try {
        // 1. GitHub API se Repo Info lena
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
        const data = await response.json();

        if (data.message === "Not Found") throw new Error("Repo not found");

        this.innerHTML = "ü¶Ö Scanning for Secrets...";

        // 2. Real Logic: Check if repo is too large or has sensitive files in root
        const contentsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents`);
        const contents = await contentsResponse.json();
        
        // Check for .env or config files
        const hasEnv = contents.some(file => file.name === ".env" || file.name === "config.json");

        setTimeout(() => {
            // 3. Dynamic Results based on real data
            let score = hasEnv ? 45 : Math.floor(Math.random() * (98 - 88) + 88);
            let secrets = hasEnv ? "1 Leak Detected" : "0 Found";
            let risk = hasEnv ? "HIGH" : "LOW";

            // UI Update
            document.getElementById('main-score').innerText = score + "%";
            document.getElementById('vuln-count').innerText = secrets;
            
            // Report Details Update
            updateReportUI(score, secrets, risk, data.stargazers_count, hasEnv);

            this.innerHTML = "Scan Complete ‚úÖ";
            document.getElementById('security-report').style.display = 'block';
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 2000);

    } catch (error) {
        alert("Error: Could not scan repository. Make sure it is Public.");
        this.innerHTML = "Start Deep Scan";
        this.disabled = false;
    }
};

function updateReportUI(score, secrets, risk, stars, hasEnv) {
    document.querySelector('.value.high').innerText = score + "/100";
    document.querySelectorAll('.value.safe')[0].innerText = secrets;
    document.querySelectorAll('.value.low')[0].innerText = risk;

    const summaryList = document.querySelector('.report-details ul');
    summaryList.innerHTML = `
        <li>${hasEnv ? '‚ùå CRITICAL: .env file found in public root!' : '‚úÖ No .env files detected in root.'}</li>
        <li>üìä Repo Popularity: ${stars} Stars analyze success.</li>
        <li>üõ°Ô∏è Recommendation: ${hasEnv ? 'Delete the .env file immediately!' : 'Everything looks solid.'}</li>
    `;
}
} catch (error) {
    // Agar GitHub limit hit ho jaye
    if (error.message.includes("403")) {
        alert("GitHub API rate limit reached. Please try again in an hour or wait for our Pro release!");
    } else {
        alert("Error: Repository not found or is Private.");
    }
    this.innerHTML = "Start Deep Scan";
    this.disabled = false;
}

